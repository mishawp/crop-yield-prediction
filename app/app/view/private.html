<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Prediction App</title>
    <link rel="stylesheet" href="./styles/private.css" />
  </head>
  <body>
    <div class="header">
      <h2>Welcome, {{ user.username }}!</h2>
      <a href="/auth/logout" class="btn-logout">Logout</a>
    </div>

    <div class="card">
      <h3>Make a Prediction</h3>
      <form
        method="POST"
        enctype="multipart/form-data"
        action="/api/ml/send_task"
        id="prediction-form"
      >
        <div class="form-group">
          <label for="modelFile">Upload .npz file:</label>
          <input
            type="file"
            id="modelFile"
            name="file"
            accept=".npz"
            required
          />
        </div>

        <button type="submit">Predict</button>
      </form>

      <div class="status">
        Status: <span id="status-value">Not started</span>
      </div>
      <div class="result" id="prediction-result" style="display: none">
        Prediction Result: <span id="prediction-value"></span>
      </div>
    </div>

    <a href="api/ml/tasks" class="btn-history">View History</a>

    <script>
      document
        .getElementById("prediction-form")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const formData = new FormData(this);
          const statusElement = document.getElementById("status-value");
          const resultElement = document.getElementById("prediction-value");
          const resultContainer = document.getElementById("prediction-result");

          // Reset UI
          statusElement.textContent = "Processing...";
          resultContainer.style.display = "none";

          fetch("/api/ml/send_task", {
            method: "POST",
            body: formData,
            credentials: "include",
          })
            .then((response) => response.json())
            .then((data) => {
              const taskId = data.task_id;
              checkTaskStatus(taskId);
            })
            .catch((error) => {
              console.error("Error:", error);
              statusElement.textContent = "Error submitting task";
            });
        });

      function checkTaskStatus(taskId) {
        const statusElement = document.getElementById("status-value");
        const resultElement = document.getElementById("prediction-value");
        const resultContainer = document.getElementById("prediction-result");

        fetch(`/api/ml/receive_task_result?task_id=${taskId}`)
          .then((response) => response.json())
          .then((data) => {
            statusElement.textContent = data.status;

            if (data.status === "completed") {
              resultElement.textContent = data.result;
              resultContainer.style.display = "block";
              return;
            }

            if (data.status === "failed") {
              return;
            }

            // If still processing, check again after 2 seconds
            setTimeout(() => {
              checkTaskStatus(taskId);
            }, 2000);
          })
          .catch((error) => {
            console.error("Error checking task status:", error);
            statusElement.textContent = "Error checking status";
          });
      }
    </script>
  </body>
</html>
