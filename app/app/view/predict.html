{% block title %} Crop Yield Prediction | Make Prediction {% endblock %} {%
block head %}
<style type="text/css">
  .prediction-card {
    max-width: 600px;
    margin: 2rem auto;
    padding: 2rem;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    background: white;
  }
  .form-group {
    margin-bottom: 1.5rem;
  }
  .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
  }
  .form-control {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #ced4da;
    border-radius: 4px;
  }
  .btn-predict {
    background-color: #2e7d32;
    color: white;
    width: 100%;
    padding: 0.75rem;
    border: none;
    border-radius: 4px;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  .btn-predict:hover {
    background-color: #1b5e20;
  }
  .btn-history {
    display: block;
    text-align: center;
    margin: 1rem auto;
    padding: 0.75rem;
    border: 1px solid #2e7d32;
    border-radius: 4px;
    color: #2e7d32;
    text-decoration: none;
    max-width: 600px;
    transition: all 0.3s;
  }
  .btn-history:hover {
    background-color: #2e7d32;
    color: white;
  }
  .status-indicator {
    margin: 1.5rem 0;
    padding: 1rem;
    border-radius: 4px;
    background-color: #f8f9fa;
  }
  .status-value {
    font-weight: 500;
  }
  .processing {
    color: #ffc107;
  }
  .completed {
    color: #28a745;
  }
  .failed {
    color: #dc3545;
  }
  .result-container {
    margin-top: 1.5rem;
    padding: 1rem;
    border-radius: 4px;
    background-color: #e8f5e9;
    display: none;
  }
  .result-value {
    font-weight: 500;
    color: #2e7d32;
  }
  .user-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #dee2e6;
  }
  .btn-logout {
    padding: 0.5rem 1rem;
    background-color: #f8f9fa;
    border: 1px solid #dc3545;
    border-radius: 4px;
    color: #dc3545;
    text-decoration: none;
    transition: all 0.3s;
  }
  .btn-logout:hover {
    background-color: #dc3545;
    color: white;
  }
</style>
{% endblock %} {% block content %}
<div class="container">
  <div class="user-header">
    <h2>Welcome, {{ user }}!</h2>
    <a href="/auth/logout" class="btn-logout">–í—ã–π—Ç–∏</a>
  </div>

  <div class="prediction-card">
    <h3>üåæ Make a Prediction</h3>
    <form
      method="POST"
      enctype="multipart/form-data"
      action="/api/ml/send_task"
      id="prediction-form"
    >
      <div class="form-group">
        <label for="file"
          >–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –≤ —Ñ–æ—Ä–º–∞—Ç–µ .npz, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –Ω–∞–±–æ—Ä —Å–Ω–∏–º–∫–æ–≤ images –∏
          —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –∏–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã coordinates:</label
        >
        <input
          type="file"
          class="form-control"
          id="file"
          name="file"
          accept=".npz"
          required
        />
      </div>

      <button type="submit" class="btn-predict">Predict Yield</button>
    </form>

    <div class="status-indicator">
      Status: <span id="status-value" class="status-value">Not started</span>
    </div>
    <div class="result-container" id="prediction-result">
      Prediction Result:
      <span id="prediction-value" class="result-value"></span>
    </div>
  </div>

  <a href="/api/ml/tasks" class="btn-history">üìã View Prediction History</a>
</div>

<script>
  document
    .getElementById("prediction-form")
    .addEventListener("submit", function (e) {
      e.preventDefault();

      const formData = new FormData(this);
      const statusElement = document.getElementById("status-value");
      const resultElement = document.getElementById("prediction-value");
      const resultContainer = document.getElementById("prediction-result");

      // Reset UI
      statusElement.textContent = "Processing...";
      statusElement.className = "status-value processing";
      resultContainer.style.display = "none";

      fetch("/api/ml/send_task", {
        method: "POST",
        body: formData,
        credentials: "include",
      })
        .then((response) => response.json())
        .then((data) => {
          const taskId = data.task_id;
          checkTaskStatus(taskId);
        })
        .catch((error) => {
          console.error("Error:", error);
          statusElement.textContent = "Error submitting task";
          statusElement.className = "status-value failed";
        });
    });

  function checkTaskStatus(taskId) {
    const statusElement = document.getElementById("status-value");
    const resultElement = document.getElementById("prediction-value");
    const resultContainer = document.getElementById("prediction-result");

    fetch(`/api/ml/receive_task_result?task_id=${taskId}`)
      .then((response) => response.json())
      .then((data) => {
        statusElement.textContent = data.status;

        if (data.status === "completed") {
          statusElement.className = "status-value completed";
          resultElement.textContent = data.result;
          resultContainer.style.display = "block";
          return;
        }

        if (data.status === "failed") {
          statusElement.className = "status-value failed";
          return;
        }

        // If still processing, check again after 2 seconds
        setTimeout(() => {
          checkTaskStatus(taskId);
        }, 2000);
      })
      .catch((error) => {
        console.error("Error checking task status:", error);
        statusElement.textContent = "Error checking status";
        statusElement.className = "status-value failed";
      });
  }
</script>
{% endblock %}
