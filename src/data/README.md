# Обработка данных

## 1. Интеграция данных

### Корректировки под baseline:

- Снимки Sentinel **не используются**. Только табличные данные.

### Имеющиеся данные

1. [Спутниковые снимки Sentinel](../../notebooks/1.1-data-review-sentinel.ipynb);
2. [Климатические данные](../../notebooks/1.3-data-review-wrf-hrrr.ipynb);
3. [Данные о влажности почвы](../../notebooks/1.4-data-review-moisture.ipynb);
4. [Исторические данные об урожайности](../../notebooks/1.2-data-review-usda.ipynb).

**Необходимо** объединить их в единое целое.

### Структура будущего датасета

```plaintext
interim
    |
    ├── X.csv                               # Табличные данные. Признаки
    |
    ├── y.csv                               # Таргетные значения
    |
    └── images/
        ├── <fips>-<year>-<month>-<day>     # Набор снимков для одного округа и даты
        |   ├── 1.npy
        |   ├── 2.npy
        |   └── ...
        |
        └── ...                             # Остальные наборы снимков
```

### Шаги интеграции

1. Возьмем данные *за 1 и 15 дни* каждого месяца
2. Удалим метаданные из таблиц
3. Усредним данные для каждого округа (fips)
4. Таргетной переменной является `YIELD, MEASURED IN BU / ACRE` из таблицы *USDA*. `PRODUCTION, MEASURED IN BU` удаляем
5. Соединяем *WRF-HRRR* с *ERA5* по дате и fips. Полученный DataFrame обозначим через *X*
6. Добавляем в *X* столбец `images` - пути к изображениям *Sentinel*
7. Копируем изображения в формате, как показано в [структуре будущего проекта](#структура-будущего-датасета)
8. Сортируем по year, fips, month, day
9. Сохраняем *X* как `data/interim/X.csv` и данные *USDA* как `data/interim/y.csv`

## 2. Преодобработка данных

Полученные после [интеграции](#1-интеграция-данных) нужно обработать и создать обучающую и тестовую выборки

1. Добавим столбец `target_year`, который ставит в соответствие объект и таргет. В частности, для периода месяцев *ноябрь-декабрь* `target_year = year + 1`, т.к. сбор урожая кукурузы происходит в *сентябре-октябре*.
2. Удаляем данные *первого года январь-октябрь* и *последнего года ноябрь-декабрь*
3. Удаляем лишние признаки: координаты, максимальная и минимальные температуры.
4. Соединяем признаки с таргетами по (`target_year`, `fips`) и (`year`, `target`) соответственно
5. Сортируем
   - Приводим строки в правильный порядок. Т.к. считаем урожайность на данных ноябрь-август, то первыми должны идти данные за ноябрь-декабрь предыдущего года (в текущем `data` все ноябри-декабри относятся к "будущему году". Напр., у фактического ноября 2017-ого в `year` будет стоять 2018. Так сделано для удобства)
6. Обрабатываем `NaN` значений
    - Не для каждого `target_year`, `fips` мы будем иметь значение `yield_bu_per_acre`. Нужно от них избавиться, учитывая условие ниже;
    - для `year`, `fips` в текущего года, может не быть значения `yield_bu_per_acre` прошлого года, но для *ноябрь-сентябрь* предыдущего года нам нужны значения текущего
7. Удаляем *сентябрь-октябрь*
8. Разделяем на *train*, *test*. В качестве *test* возьмем последний год
9. Сохраняем в `data/processed/` `X_train`, `X_test`, `y_train`, `y_test`
