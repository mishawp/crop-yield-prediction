# Обработка данных

## 1. Интеграция данных

### Имеющиеся данные

1. [Спутниковые снимки Sentinel](../../notebooks/1.1-data-review-sentinel.ipynb);
2. [Климатические данные](../../notebooks/1.3-data-review-wrf-hrrr.ipynb);
3. [Данные о влажности почвы](../../notebooks/1.4-data-review-moisture.ipynb);
4. [Исторические данные об урожайности](../../notebooks/1.2-data-review-usda.ipynb).

**Необходимо** объединить их в единое целое.

### Структура будущего датасета

```plaintext
interim
    |
    ├── X.csv                                   # Табличные данные. Признаки
    |
    ├── y.csv                                   # Таргетные значения
    |
    └── images/
        ├── <fips>-<year>-<month>-<day>.npy     # Набор снимков для одного округа и даты
        |
        └── ...                                 # Остальные наборы снимков
```

### Шаги интеграции

1. Возьмем данные *за все дни*
2. Удалим метаданные из таблиц
3. Усредним данные для каждого округа (fips)
4. Таргетной переменной является `YIELD, MEASURED IN BU / ACRE` из таблицы *USDA*. `PRODUCTION, MEASURED IN BU` удаляем
5. ~~Соединяем *WRF-HRRR* с *ERA5* по дате и fips. Полученный DataFrame обозначим через *X*~~
6. Добавляем в *X* столбец `images` - пути к изображениям *Sentinel*
7. ~~Копируем изображения в формате, как показано в [структуре будущего проекта](#структура-будущего-датасета)~~
8. ~~Удаляем те данные, для которых нет изображений~~
9. Сортируем по year, fips, month, day
10. Сохраняем *X* как `data/interim/X.csv` и данные *USDA* как `data/interim/y.csv`

## 2. Преодобработка данных

Полученные после [интеграции](#1-интеграция-данных) нужно обработать и создать обучающую и тестовую выборки

1. Берем данные за *март-август* включительно
2. Соединяем признаки с таргетами по (`target_year`, `fips`) и (`year`, `target`) соответственно
3. Разделяем на *train*, *test*. В качестве *test* возьмем последний год
4. Нормализуем данные
5. Сохраняем в `data/processed/` `X_train`, `X_test`, `y_train`, `y_test`
